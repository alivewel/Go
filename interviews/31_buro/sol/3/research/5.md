–ø–æ—á–µ–º—É —É –Ω–∞—Å –ø—Ä–∏ CAS, –µ—Å–ª–∏ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å –∑–Ω–∞—á–µ–Ω–∏–µ, —Ç–æ –∏ –∞–¥—Ä–µ—Å –º–µ–Ω—è–µ—Ç—Å—è?

---

–û—Ç–ª–∏—á–Ω—ã–π –≤–æ–ø—Ä–æ—Å ‚Äî –∏ –Ω–∞ —Å–∞–º–æ–º –¥–µ–ª–µ –≤ –Ω—ë–º **–µ—Å—Ç—å –ø–æ–¥–º–µ–Ω–∞ –ø–æ–Ω—è—Ç–∏–π**, –¥–∞–≤–∞–π —Ä–∞–∑–ª–æ–∂–∏–º –≤—Å—ë –ø–æ –ø–æ–ª–æ—á–∫–∞–º:

---

## üß† –ö—Ä–∞—Ç–∫–∏–π –æ—Ç–≤–µ—Ç:

> ‚ùó **CAS (`Compare-And-Swap`) –Ω–µ –º–µ–Ω—è–µ—Ç –∞–¥—Ä–µ—Å**, –æ–Ω —Å—Ä–∞–≤–Ω–∏–≤–∞–µ—Ç –∏ (–≤–æ–∑–º–æ–∂–Ω–æ) –∑–∞–º–µ–Ω—è–µ—Ç **–∑–Ω–∞—á–µ–Ω–∏–µ –ø–æ –∞–¥—Ä–µ—Å—É**.
> ‚ö†Ô∏è –ï—Å–ª–∏ —Ç—ã –≤–∏–¥–∏—à—å, —á—Ç–æ "–∑–Ω–∞—á–µ–Ω–∏–µ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å ‚Üí –∏ –∞–¥—Ä–µ—Å –¥—Ä—É–≥–æ–π", —Ç–æ —ç—Ç–æ –Ω–µ –∏–∑-–∑–∞ **CAS**, –∞ –ø–æ—Ç–æ–º—É —á—Ç–æ **—Å–∞–º –æ–±—ä–µ–∫—Ç –±—ã–ª –ø–µ—Ä–µ—Å–æ–∑–¥–∞–Ω –∏–ª–∏ –ø–µ—Ä–µ–º–µ—â—ë–Ω** (–Ω–∞–ø—Ä–∏–º–µ—Ä, –ø—Ä–∏ `append`, `copy`, `make` –∏ —Ç.–¥.).

---

## üìå –ß—Ç–æ –¥–µ–ª–∞–µ—Ç CAS –≤ Go (—á–µ—Ä–µ–∑ `atomic.CompareAndSwapX`)

–ü—Ä–∏–º–µ—Ä:

```go
atomic.CompareAndSwapInt64(&x, old, new)
```

* –°—Ä–∞–≤–Ω–∏–≤–∞–µ—Ç `*x == old`
* –ï—Å–ª–∏ —Ä–∞–≤–Ω–æ ‚Üí –∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç `new` –≤ `*x`
* –í—Å—ë —ç—Ç–æ ‚Äî **–ø–æ –∞–¥—Ä–µ—Å—É `&x`**
* ‚ùó **–ê–¥—Ä–µ—Å `&x` –æ—Å—Ç–∞—ë—Ç—Å—è —Ç–µ–º –∂–µ!**

---

## üîç –û—Ç–∫—É–¥–∞ –∂–µ —Ç–æ–≥–¥–∞ –≤–æ–∑–Ω–∏–∫–∞–µ—Ç –æ—â—É—â–µ–Ω–∏–µ "—Å–º–µ–Ω—ã –∞–¥—Ä–µ—Å–∞"?

### üìå –ü—Ä–∏–º–µ—Ä —Å `slice`:

```go
s := []int{1, 2, 3}
p := &s[0]
s = append(s, 4, 5, 6, 7, 8) // ‚ùó –Ω–æ–≤—ã–π –º–∞—Å—Å–∏–≤ –ø–æ–¥ –∫–∞–ø–æ—Ç–æ–º!
```

* `s[0]` —Ç–µ–ø–µ—Ä—å **–≤ –Ω–æ–≤–æ–º –º–∞—Å—Å–∏–≤–µ**
* –ê `p` ‚Äî —É–∫–∞–∑—ã–≤–∞–µ—Ç –Ω–∞ **—Å—Ç–∞—Ä—ã–π –∞–¥—Ä–µ—Å**
* –ó–Ω–∞—á–µ–Ω–∏—è –º–æ–≥—É—Ç –±—ã—Ç—å —Ç–µ –∂–µ, **–Ω–æ –ø–∞–º—è—Ç—å ‚Äî –¥—Ä—É–≥–∞—è**

–ò —ç—Ç–æ **–Ω–µ —Å–≤—è–∑–∞–Ω–æ —Å CAS**. –≠—Ç–æ —Å–≤—è–∑–∞–Ω–æ —Å —Ç–µ–º, —á—Ç–æ:

* `append` —Å–æ–∑–¥–∞–ª –Ω–æ–≤—ã–π –º–∞—Å—Å–∏–≤
* `s` —Ç–µ–ø–µ—Ä—å —Å—Å—ã–ª–∞–µ—Ç—Å—è –Ω–∞ –¥—Ä—É–≥–æ–π –º–∞—Å—Å–∏–≤
* –ê `p` ‚Äî –Ω–∞ —Å—Ç–∞—Ä—ã–π

---

## üì¶ CAS —Ä–∞–±–æ—Ç–∞–µ—Ç —Å —á–µ–º?

| –¢–∏–ø                   | CAS –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å? | –ê–¥—Ä–µ—Å –º–æ–∂–µ—Ç –∏–∑–º–µ–Ω–∏—Ç—å—Å—è —Å–∞–º –ø–æ —Å–µ–±–µ? |
| --------------------- | ----------------------- | ----------------------------------- |
| `int64`, `int32`      | ‚úÖ –î–∞                    | ‚ùå –ù–µ—Ç                               |
| `uintptr`, `bool`     | ‚úÖ –î–∞                    | ‚ùå –ù–µ—Ç                               |
| `*MyStruct`           | ‚úÖ –î–∞ (`unsafe.Pointer`) | ‚ùå –ù–µ—Ç (–µ—Å–ª–∏ —É–∫–∞–∑–∞—Ç–µ–ª—å —Å—Ç–∞–±–∏–ª–µ–Ω)     |
| `[]int`, `map` –∏ —Ç.–ø. | ‚ö†Ô∏è –¢–æ–ª—å–∫–æ —É–∫–∞–∑–∞—Ç–µ–ª—å     | ‚úÖ –î–∞ (–∏–∑-–∑–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤–Ω—É—Ç—Ä–∏)       |

---

## üî¨ –•–∏—Ç—Ä—ã–π –ø—Ä–∏–º–µ—Ä: CAS —Å —É–∫–∞–∑–∞—Ç–µ–ª–µ–º

```go
type Node struct {
    value int
    next  *Node
}

var head unsafe.Pointer

// –¥–æ–ø—É—Å—Ç–∏–º —Ö–æ—Ç–∏–º –∑–∞–º–µ–Ω–∏—Ç—å –≥–æ–ª–æ–≤—É
func updateHead(new *Node) {
    for {
        old := atomic.LoadPointer(&head)
        if atomic.CompareAndSwapPointer(&head, old, unsafe.Pointer(new)) {
            break
        }
    }
}
```

* –ó–¥–µ—Å—å CAS —Ä–∞–±–æ—Ç–∞–µ—Ç **—Å —É–∫–∞–∑–∞—Ç–µ–ª–µ–º `head`**
* –ú—ã –º–µ–Ω—è–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ **–ø–æ –∞–¥—Ä–µ—Å—É `&head`**
* –°–∞–º –∞–¥—Ä–µ—Å `&head` –æ—Å—Ç–∞—ë—Ç—Å—è —Ç–µ–º –∂–µ

---

## üß† –ò—Ç–∞–∫, –≤—ã–≤–æ–¥:

| –ß—Ç–æ                                  | –ú–µ–Ω—è–µ—Ç—Å—è?                   | –ü–æ—á–µ–º—É?                   |
| ------------------------------------ | --------------------------- | ------------------------- |
| –ó–Ω–∞—á–µ–Ω–∏–µ –ø–æ CAS                      | ‚úÖ –î–∞, –µ—Å–ª–∏ —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ –ø—Ä–æ—à–ª–æ | –≠—Ç–æ —Ü–µ–ª—å CAS              |
| –ê–¥—Ä–µ—Å –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π                     | ‚ùå –ù–µ—Ç                       | CAS –Ω–µ –≤–ª–∏—è–µ—Ç –Ω–∞ –∞–¥—Ä–µ—Å    |
| –ê–¥—Ä–µ—Å —ç–ª–µ–º–µ–Ω—Ç–∞ —Å–ª–∞–π—Å–∞ –ø–æ—Å–ª–µ `append` | ‚úÖ –ú–æ–∂–µ—Ç                     | Go –≤—ã–¥–µ–ª–∏–ª –Ω–æ–≤—ã–π –º–∞—Å—Å–∏–≤   |
| –ê–¥—Ä–µ—Å —É–∫–∞–∑–∞—Ç–µ–ª—è –ø—Ä–∏ `new`, `:=`      | ‚úÖ –ú–æ–∂–µ—Ç                     | –≠—Ç–æ —É–∂–µ –¥—Ä—É–≥–∞—è –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è |

---

–•–æ—á–µ—à—å ‚Äî –º–æ–≥—É —Å–º–æ–¥–µ–ª–∏—Ä–æ–≤–∞—Ç—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π —Å–ª—É—á–∞–π, –≥–¥–µ —Ç—ã –≤–∏–¥–∏—à—å "—Å–º–µ–Ω—É –∞–¥—Ä–µ—Å–∞" ‚Äî –∏ –æ–±—ä—è—Å–Ω–∏—Ç—å, —á—Ç–æ –Ω–∞ —Å–∞–º–æ–º –¥–µ–ª–µ –ø—Ä–æ–∏–∑–æ—à–ª–æ. –•–æ—á–µ—à—å?
