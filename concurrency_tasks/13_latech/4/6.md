1) У нас есть составной индекс myIdx, в запросе у нас нет фильтрации по customer_id, этот индекс будет использоваться?

CREATE INDEX myIdx ON carts(customer_id, sku, country);

Как узнать будет ли использоваться индекс?
Можно посмотреть через explaine.

#### Почему индекс может не использоваться

1. **Порядок столбцов**: Составные индексы работают по принципу "слева направо". Это означает, что для эффективного использования индекса необходимо фильтровать по первому столбцу индекса (`customer_id` в вашем случае). Если фильтрация идет только по `sku` или `country`, индекс может не использоваться.

2. **Тип запроса**: Если запрос не содержит условий, которые могут быть оптимизированы с помощью индекса, например, если он просто выбирает все строки или использует сложные условия, индекс также может не использоваться.

### Как узнать, будет ли использоваться индекс

Чтобы проверить, будет ли использоваться индекс в вашем запросе, вы можете воспользоваться следующими методами:

1. **EXPLAIN**: Используйте команду `EXPLAIN` перед вашим запросом. Это покажет, как SQL-сервер планирует выполнить запрос и какие индексы будут использоваться. Например:

   ```sql
   EXPLAIN SELECT * FROM carts WHERE sku = 'some_value';
   ```

   В результате вы увидите информацию о том, будет ли использоваться индекс `myIdx`.

2. **Профилирование запросов**: В некоторых системах управления базами данных (СУБД) вы можете включить профилирование запросов, чтобы получить более детальную информацию о том, как выполняются запросы и какие индексы используются.

3. **Анализ производительности**: Запустите запрос с и без индекса и сравните время выполнения. Если запрос выполняется значительно быстрее с индексом, это может указывать на его использование.

2) У нас есть индекс myIdx по колонке country. Всегда ли он будет работать? Какая характеристика используется при анализе применения индекса?

CREATE INDEX myIdx ON carts(country);

Селективностью индекса назвается характеристика, определяющая, насколько эффективно индекс разбивает данные.

Индекс – это отсортированный набор значений. Применяются для уменьшения времени выполнения запроса. Создаются для колонки при условии использования в:

WHERE;
ORDER BY;
Агрегатных функциях(MIN и MAX).

Составной индекс - индекс, который создан по 2+ полям. Работает так же как и обычный индекс, но информация из колонок храниться вместе. Очередность колонок в индексе важна. Обычно колонки, которые используются в условиях WHERE, следует ставить в начало индекса. Колонки из ORDER BY — в конец.


Селективность колонки определяется количеством записей в таблице с одинаковыми значениями. Когда записей с одинаковым значением мало – селективность высокая. Такие колонки необходимо использовать первыми в составных индексах.

Лекция 6 Индексы и селективность от Postgres Pro
https://edu.postgrespro.ru/sqlprimer/sqlprimer-2019-msu-06.pdf

### Чем руководствуется планировщик запроса, когда строит запрос и думает надо ли использовать индекс?

1. Селективность индекса
Планировщик анализирует, насколько уникальны значения в столбце, на который создан индекс. Селективность — это отношение количества уникальных значений к общему количеству строк в таблице. Чем выше селективность, тем более эффективным будет индекс для фильтрации данных. Если индекс имеет низкую селективность (например, много одинаковых значений), планировщик может решить, что использование индекса нецелесообразно.
2. Объем данных
Планировщик также учитывает, сколько строк будет возвращено запросом. Если запрос возвращает большую часть таблицы, он может предпочесть полное сканирование таблицы вместо использования индекса, так как это может быть быстрее. В таких случаях полное сканирование может быть более эффективным, чем использование индекса, который требует дополнительных операций для доступа к данным.
3. Тип запроса
Тип SQL-запроса также влияет на решение о использовании индекса. Например, запросы с условиями WHERE, JOIN и ORDER BY могут использовать индексы для оптимизации выполнения. Если запрос включает сложные условия или подзапросы, планировщик будет анализировать, как индексы могут помочь в их выполнении.
4. Статистика таблицы
Планировщик использует статистику, собранную о таблицах и индексах, чтобы оценить, как лучше всего выполнить запрос. Эта статистика включает информацию о количестве строк, распределении значений и других характеристиках данных. На основе этой информации планировщик может предсказать, какой метод доступа (индекс или полное сканирование) будет наиболее эффективным.
5. Наличие нескольких индексов
Если на таблице есть несколько индексов, планировщик будет сравнивать их и выбирать тот, который, по его мнению, обеспечит наилучшее выполнение запроса. Он будет учитывать селективность каждого индекса и его соответствие условиям запроса.
6. Кэширование и производительность
Планировщик также может учитывать, как часто данные обновляются и как они кэшируются. Если данные часто изменяются, использование индекса может быть менее эффективным, так как индекс может требовать частого обновления.