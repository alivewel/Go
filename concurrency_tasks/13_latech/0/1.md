### За счёт чего обеспечивается отказоустойчивость Кафки?

Она пишет на диск дампы свои. Можно настроить несколько реплик.

Данные с сегмента реплицируются на множестве брокеров, чтобы данные сохранились, если один из брокеров откажет.

Отказоустойчивость Apache Kafka достигается за счет репликации данных, управления лидерами и последователями, настройки подтверждений, долговременного хранения данных на диске, мониторинга состояния системы и использования Zookeeper.

1. Репликация данных
Одним из основных способов обеспечения отказоустойчивости является репликация. Каждое сообщение, отправляемое в Kafka, хранится в виде записей в темах, которые могут быть реплицированы на нескольких брокерах. Это означает, что если один брокер выходит из строя, другие брокеры могут продолжать обслуживать запросы, так как у них есть копии данных. Репликация позволяет избежать потери данных и обеспечивает доступность сообщений.
2. Лидер и последователи
В каждой партиции темы есть лидер и несколько последователей. Лидер обрабатывает все записи и запросы на чтение, в то время как последователи реплицируют данные от лидера. Если лидер выходит из строя, один из последователей может быть автоматически назначен новым лидером, что минимизирует время простоя и обеспечивает непрерывность работы.
3. Настройки подтверждений (acks)
Kafka предоставляет настройки для управления подтверждениями сообщений, которые отправляются продюсерами. Например, настройка acks=all требует, чтобы все реплики подтвердили получение сообщения, прежде чем оно будет считаться успешно отправленным. Это повышает надежность, так как гарантирует, что данные будут доступны даже в случае сбоя одного из брокеров.
4. Сохранение данных на диске
Сообщения в Kafka сохраняются на диске, что обеспечивает их долговременное хранение. Это позволяет восстановить данные после сбоя системы. Kafka использует журналирование, что означает, что все записи добавляются в конец лог-файла, и в случае сбоя можно восстановить состояние системы до последнего подтвержденного сообщения.
5. Мониторинг и управление
Kafka предоставляет инструменты для мониторинга состояния кластера и его компонентов. Это позволяет администраторам быстро реагировать на сбои и проблемы, что способствует поддержанию высокой доступности и отказоустойчивости системы.
6. Использование Zookeeper
Kafka использует Zookeeper для управления метаданными и координации между брокерами. Zookeeper помогает отслеживать состояние брокеров, управлять репликацией и обеспечивать согласованность данных. Хотя в новых версиях Kafka рассматриваются альтернативы Zookeeper, его роль в обеспечении отказоустойчивости остается важной.

### Какие гарантии доставки предоставляет Кафка?

1. At-most-once (не более одного раза)
При использовании этой гарантии сообщения могут быть потеряны, но никогда не будут дублироваться. Это означает, что продюсер может отправить сообщение, и в случае сбоя оно может не быть доставлено. Эта опция подходит для сценариев, где потеря некоторых сообщений допустима, и важнее минимизировать задержки.
2. At-least-once (не менее одного раза)
Эта гарантия обеспечивает, что каждое сообщение будет доставлено как минимум один раз. Однако в случае сбоя или повторной отправки сообщения может произойти дублирование. Это наиболее распространенный уровень гарантии, который подходит для большинства приложений, где важно, чтобы сообщения не терялись, даже если это может привести к дублированию.
3. Exactly-once (однократная доставка)
Эта гарантия обеспечивает, что каждое сообщение будет доставлено ровно один раз, без потерь и дублирования. Это наиболее сложный уровень гарантии, который требует дополнительных механизмов для обработки дублирования и обеспечения согласованности. Kafka реализует эту функциональность через механизмы транзакций, которые позволяют продюсерам и консьюмерам работать с сообщениями так, чтобы избежать дублирования.
Как это работает
At-most-once: При использовании этой гарантии продюсер может не дожидаться подтверждения от брокера, что снижает задержку, но увеличивает риск потери сообщений.
At-least-once: В этом случае продюсер ждет подтверждения от брокера, что гарантирует доставку, но может привести к повторной отправке сообщений в случае ошибок, что вызывает дублирование.
Exactly-once: Для достижения этой гарантии Kafka использует механизмы, такие как идемпотентные продюсеры и транзакции, которые позволяют избежать дублирования сообщений даже в случае сбоя.