–ù–µ–æ–±—Ö–æ–¥–∏–º–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–Ω—ã–π –ø–æ–∏—Å–∫ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–∞—Ö. –î–ª—è —ç—Ç–æ–≥–æ —É –Ω–∞—Å –µ—Å—Ç—å —Å—Ç–æ—Ä–æ–Ω–Ω—è—è –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ —Å —Ñ—É–Ω–∫—Ü–∏–µ–π
search.Search(server string, query string) ([]string, error)
–∫–æ—Ç–æ—Ä–∞—è –æ—Å—É—â–µ—Å—Ç–≤–ª—è–µ—Ç –ø–æ–∏—Å–∫ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ –Ω–∞ —É–∫–∞–∑–∞–Ω–Ω–æ–º —Å–µ—Ä–≤–µ—Ä–µ –ø–æ —É–∫–∞–∑–∞–Ω–Ω–æ–º—É –∑–∞–ø—Ä–æ—Å—É. –£ –Ω–∞—Å –µ—Å—Ç—å N —Å–µ—Ä–≤–µ—Ä–æ–≤ –∏–¥–µ–Ω—Ç–∏—á–Ω—ã—Ö (—Ä–µ–ø–ª–∏–∫–∏) –∏ –∑–∞–¥–∞—á–∞ —Å–æ—Å—Ç–æ–∏—Ç –≤ —Ç–æ–º, —á—Ç–æ–±—ã –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–Ω–æ –≤—ã–∑–≤–∞—Ç—å —ç—Ç—É —Ñ—É–Ω–∫—Ü–∏—é –¥–ª—è –≤—Å–µ—Ö —Å–µ—Ä–≤–µ—Ä–æ–≤ –∏ –≤–µ—Ä–Ω—É—Ç—å –ø–µ—Ä–≤—ã–π —É—Å–ø–µ—à–Ω—ã–π –æ—Ç–≤–µ—Ç –æ—Ç –ª—é–±–æ–≥–æ –∏–∑ —Å–µ—Ä–≤–µ—Ä–æ–≤ –Ω–µ –¥–æ–∂–∏–¥–∞—è—Å—å –æ—Ç–≤–µ—Ç–æ–≤ –æ—Ç –¥—Ä—É–≥–∏—Ö —Å–µ—Ä–≤–µ—Ä–æ–≤. –ï—Å–ª–∏ –∫–∞–∫–æ–π-—Ç–æ —Å–µ—Ä–≤–µ—Ä –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –æ—à–∏–±–∫—É, —Ç–æ –º—ã –µ–µ –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º, –¥–æ–∂–∏–¥–∞—è—Å—å —É—Å–ø–µ—à–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç–∞ –æ—Ç –¥—Ä—É–≥–∏—Ö, –Ω–æ –µ—Å–ª–∏ –≤—Å–µ —Å–µ—Ä–≤–µ—Ä–∞ –æ—Ç–≤–µ—Ç–∏–ª–∏ –æ—à–∏–±–∫–æ–π, —Ç–æ –Ω–∞—à–∞ —Ñ—É–Ω–∫—Ü–∏—è –¥–æ–ª–∂–Ω–∞ –≤–µ—Ä–Ω—É—Ç—å –æ—à–∏–±–∫—É, —á—Ç–æ –ø–æ–∏—Å–∫ –Ω–µ —É–¥–∞–ª—Å—è.

``` go
func Search(servers []string, query string) ([]string, error) {

}
```



----------




–í–æ—Ç —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è —Ñ—É–Ω–∫—Ü–∏–∏ `Search`, –∫–æ—Ç–æ—Ä–∞—è –≤—ã–ø–æ–ª–Ω—è–µ—Ç –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–Ω—ã–π –ø–æ–∏—Å–∫ –Ω–∞ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö —Å–µ—Ä–≤–µ—Ä–∞—Ö –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ø–µ—Ä–≤—ã–π —É—Å–ø–µ—à–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:

```go
package main

import (
	"errors"
	"sync"
)

func Search(servers []string, query string) ([]string, error) {
	var wg sync.WaitGroup
	resultChan := make(chan []string, 1) // –ö–∞–Ω–∞–ª –¥–ª—è —É—Å–ø–µ—à–Ω–æ–≥–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
	errorChan := make(chan error, len(servers)) // –ö–∞–Ω–∞–ª –¥–ª—è –æ—à–∏–±–æ–∫

	// –ó–∞–ø—É—Å–∫–∞–µ–º –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–Ω—ã–π –ø–æ–∏—Å–∫ –Ω–∞ –∫–∞–∂–¥–æ–º —Å–µ—Ä–≤–µ—Ä–µ
	for _, server := range servers {
		wg.Add(1)
		go func(server string) {
			defer wg.Done()
			// –í—ã–∑—ã–≤–∞–µ–º —Å—Ç–æ—Ä–æ–Ω–Ω—é—é —Ñ—É–Ω–∫—Ü–∏—é –ø–æ–∏—Å–∫–∞
			res, err := search.Search(server, query)
			if err != nil {
				errorChan <- err // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –æ—à–∏–±–∫—É –≤ –∫–∞–Ω–∞–ª
				return
			}
			select {
			case resultChan <- res: // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤ –∫–∞–Ω–∞–ª
			default:
				// –ï—Å–ª–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç —É–∂–µ –Ω–∞–π–¥–µ–Ω, –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º
			}
		}(server)
	}

	// –ñ–¥–µ–º –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –≤—Å–µ—Ö –≥–æ—Ä—É—Ç–∏–Ω
	go func() {
		wg.Wait()
		close(resultChan)
		close(errorChan)
	}()

	// –í–æ–∑–≤—Ä–∞—â–∞–µ–º –ø–µ—Ä–≤—ã–π —É—Å–ø–µ—à–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç –∏–ª–∏ –æ—à–∏–±–∫—É, –µ—Å–ª–∏ –≤—Å–µ –∑–∞–ø—Ä–æ—Å—ã –Ω–µ —É–¥–∞–ª–∏—Å—å
	select {
	case res := <-resultChan:
		return res, nil
	default:
		return nil, errors.New("all servers failed to return a result")
	}
}
```

---

### **–û–±—ä—è—Å–Ω–µ–Ω–∏–µ –∫–æ–¥–∞:**

1. **–ö–∞–Ω–∞–ª—ã –¥–ª—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –∏ –æ—à–∏–±–æ–∫:**
   - `resultChan` –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –ø–µ—Ä–µ–¥–∞—á–∏ –ø–µ—Ä–≤–æ–≥–æ —É—Å–ø–µ—à–Ω–æ–≥–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞.
   - `errorChan` —Å–æ–±–∏—Ä–∞–µ—Ç –æ—à–∏–±–∫–∏ –æ—Ç —Å–µ—Ä–≤–µ—Ä–æ–≤, –µ—Å–ª–∏ –æ–Ω–∏ –≤–æ–∑–Ω–∏–∫–∞—é—Ç.

2. **–ö–æ–Ω–∫—É—Ä–µ–Ω—Ç–Ω—ã–π –≤—ã–∑–æ–≤ `search.Search`:**
   - –î–ª—è –∫–∞–∂–¥–æ–≥–æ —Å–µ—Ä–≤–µ—Ä–∞ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –≥–æ—Ä—É—Ç–∏–Ω–∞, –∫–æ—Ç–æ—Ä–∞—è –≤—ã–∑—ã–≤–∞–µ—Ç —Ñ—É–Ω–∫—Ü–∏—é `search.Search`.
   - –ï—Å–ª–∏ —Ñ—É–Ω–∫—Ü–∏—è –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –æ—à–∏–±–∫—É, –æ–Ω–∞ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –≤ `errorChan`.
   - –ï—Å–ª–∏ —Ñ—É–Ω–∫—Ü–∏—è –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —É—Å–ø–µ—à–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç, –æ–Ω –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –≤ `resultChan`.

3. **–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å –ø–æ–º–æ—â—å—é `sync.WaitGroup`:**
   - `WaitGroup` –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –æ–∂–∏–¥–∞–Ω–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –≤—Å–µ—Ö –≥–æ—Ä—É—Ç–∏–Ω.

4. **–û–±—Ä–∞–±–æ—Ç–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞:**
   - –ï—Å–ª–∏ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω —Å–µ—Ä–≤–µ—Ä –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —É—Å–ø–µ—à–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç, –æ–Ω –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è.
   - –ï—Å–ª–∏ –≤—Å–µ —Å–µ—Ä–≤–µ—Ä—ã –≤–æ–∑–≤—Ä–∞—â–∞—é—Ç –æ—à–∏–±–∫–∏, –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è –æ—à–∏–±–∫–∞ "all servers failed to return a result".

5. **–ó–∞–∫—Ä—ã—Ç–∏–µ –∫–∞–Ω–∞–ª–æ–≤:**
   - –ü–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –≤—Å–µ—Ö –≥–æ—Ä—É—Ç–∏–Ω –∫–∞–Ω–∞–ª—ã –∑–∞–∫—Ä—ã–≤–∞—é—Ç—Å—è, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å —É—Ç–µ—á–µ–∫ –ø–∞–º—è—Ç–∏.

---

### **–ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è:**

```go
package main

import (
	"fmt"
	"errors"
)

// Mock search function for testing
func mockSearch(server string, query string) ([]string, error) {
	if server == "server1" {
		return nil, errors.New("server1 failed")
	}
	if server == "server2" {
		return []string{"result1", "result2"}, nil
	}
	return nil, errors.New("server failed")
}

func main() {
	servers := []string{"server1", "server2", "server3"}
	query := "example query"

	// Replace search.Search with mockSearch for testing
	search.Search = mockSearch

	results, err := Search(servers, query)
	if err != nil {
		fmt.Println("Error:", err)
	} else {
		fmt.Println("Results:", results)
	}
}
```

---

### **–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:**
- –§—É–Ω–∫—Ü–∏—è –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç —Å—Ä–∞–∑—É, –∫–∞–∫ —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω –∏–∑ —Å–µ—Ä–≤–µ—Ä–æ–≤ —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–∞–µ—Ç –ø–æ–∏—Å–∫.
- –ï—Å–ª–∏ –≤—Å–µ —Å–µ—Ä–≤–µ—Ä—ã –≤–æ–∑–≤—Ä–∞—â–∞—é—Ç –æ—à–∏–±–∫–∏, –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è –æ—à–∏–±–∫–∞.
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–Ω—ã–π –ø–æ–¥—Ö–æ–¥ –¥–ª—è –ø–æ–≤—ã—à–µ–Ω–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏.



----------




### –ü–æ–¥—Ä–æ–±–Ω–æ–µ –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ –∫–æ–¥–∞

–≠—Ç–æ—Ç –∫–æ–¥ —Ä–µ–∞–ª–∏–∑—É–µ—Ç –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–Ω—ã–π –ø–æ–∏—Å–∫ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ –Ω–∞ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö —Å–µ—Ä–≤–µ—Ä–∞—Ö, –∏—Å–ø–æ–ª—å–∑—É—è –∞—Ç–æ–º–∞—Ä–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ (`atomic.Int32` –∏ `atomic.Bool`) –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º –±–µ–∑ `sync.Mutex`. –†–∞–∑–±–µ—Ä–µ–º –∫–æ–¥ –ø–æ—à–∞–≥–æ–≤–æ.

---

## 1. **–û–±—ä—è–≤–ª–µ–Ω–∏–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –∏ –∫–∞–Ω–∞–ª–æ–≤**
```go
response := make(chan []string, 1)
errChan := make(chan error, 1)
var errCounter atomic.Int32
var responseClosed atomic.Bool
```
- `response := make(chan []string, 1)`  
  - –ö–∞–Ω–∞–ª –¥–ª—è —É—Å–ø–µ—à–Ω—ã—Ö —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤.  
  - –ë—É—Ñ–µ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–π —Ä–∞–∑–º–µ—Ä–æ–º 1, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –≥–æ—Ä—É—Ç–∏–Ω –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –æ—Ç–≤–µ—Ç–∞.

- `errChan := make(chan error, 1)`  
  - –ö–∞–Ω–∞–ª –¥–ª—è –æ—à–∏–±–æ–∫.  
  - –¢–∞–∫–∂–µ –±—É—Ñ–µ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–π, —á—Ç–æ–±—ã –Ω–µ –±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –æ—Ç–ø—Ä–∞–≤–∫—É –æ—à–∏–±–∫–∏.

- `var errCounter atomic.Int32`  
  - –ê—Ç–æ–º–∞—Ä–Ω—ã–π —Å—á–µ—Ç—á–∏–∫ –æ—à–∏–±–æ–∫.  
  - –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è, —Å–∫–æ–ª—å–∫–æ —Å–µ—Ä–≤–µ—Ä–æ–≤ –≤–µ—Ä–Ω—É–ª–∏ –æ—à–∏–±–∫—É.

- `var responseClosed atomic.Bool`  
  - –ê—Ç–æ–º–∞—Ä–Ω—ã–π —Ñ–ª–∞–≥, –∫–æ—Ç–æ—Ä—ã–π —É–∫–∞–∑—ã–≤–∞–µ—Ç, –ø–æ–ª—É—á–µ–Ω –ª–∏ —É–∂–µ —É—Å–ø–µ—à–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç.  
  - –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –æ—Ç–ø—Ä–∞–≤–∫–∏ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –æ—Ç–≤–µ—Ç–æ–≤.

---

## 2. **–ó–∞–ø—É—Å–∫ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ –∫–æ –≤—Å–µ–º —Å–µ—Ä–≤–µ—Ä–∞–º**
```go
for _, server := range servers {
    go func(server string) {
```
- –¶–∏–∫–ª `for _, server := range servers` –ø–µ—Ä–µ–±–∏—Ä–∞–µ—Ç —Å–ø–∏—Å–æ–∫ —Å–µ—Ä–≤–µ—Ä–æ–≤.
- –î–ª—è –∫–∞–∂–¥–æ–≥–æ —Å–µ—Ä–≤–µ—Ä–∞ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è **–≥–æ—Ä—É—Ç–∏–Ωa** (`go func(server string)`), –∫–æ—Ç–æ—Ä–∞—è –±—É–¥–µ—Ç –≤—ã–ø–æ–ª–Ω—è—Ç—å –ø–æ–∏—Å–∫ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ **–∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ**.

---

## 3. **–ü—Ä–æ–≤–µ—Ä–∫–∞ `responseClosed` –ø–µ—Ä–µ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ–º –∑–∞–ø—Ä–æ—Å–∞**
```go
if responseClosed.Load() {
    return
}
```
- `responseClosed.Load()` –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ç–µ–∫—É—â–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ `responseClosed` **–∞—Ç–æ–º–∞—Ä–Ω–æ**.
- –ï—Å–ª–∏ `responseClosed == true`, –∑–Ω–∞—á–∏—Ç, –º—ã —É–∂–µ –ø–æ–ª—É—á–∏–ª–∏ —É—Å–ø–µ—à–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç –æ—Ç –¥—Ä—É–≥–æ–≥–æ —Å–µ—Ä–≤–µ—Ä–∞ ‚Üí **–≥–æ—Ä—É—Ç–∏–Ωa –∑–∞–≤–µ—Ä—à–∞–µ—Ç—Å—è** (`return`).

---

## 4. **–í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–∞ –∏ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫**
```go
document, err := search.Search(server, query)
if err != nil {
    if errCounter.Add(1) == int32(len(servers)) {
        select {
        case errChan <- fmt.Errorf("all servers reply with error"):
            close(errChan) // –ó–∞–∫—Ä—ã–≤–∞–µ–º –∫–∞–Ω–∞–ª –ø–æ—Å–ª–µ –æ—Ç–ø—Ä–∞–≤–∫–∏ –æ—à–∏–±–∫–∏
        default:
        }
    }
    return
}
```
- –í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –∑–∞–ø—Ä–æ—Å `search.Search(server, query)`.
- –ï—Å–ª–∏ –∑–∞–ø—Ä–æ—Å –≤–µ—Ä–Ω—É–ª –æ—à–∏–±–∫—É (`err != nil`):
  - `errCounter.Add(1)` **–∞—Ç–æ–º–∞—Ä–Ω–æ —É–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç** `errCounter` –Ω–∞ `1`.
  - –ï—Å–ª–∏ `errCounter == len(servers)`, –∑–Ω–∞—á–∏—Ç, **–≤—Å–µ —Å–µ—Ä–≤–µ—Ä–∞ –≤–µ—Ä–Ω—É–ª–∏ –æ—à–∏–±–∫—É**.
  - –¢–æ–≥–¥–∞ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤ `errChan` —Å–æ–æ–±—â–µ–Ω–∏–µ `"all servers reply with error"`.
  - `close(errChan)`, —á—Ç–æ–±—ã —Å–∏–≥–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –æ–± –æ–∫–æ–Ω—á–∞–Ω–∏–∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫.
  - –í–æ–∑–≤—Ä–∞—â–∞–µ–º `return`, **–≥–æ—Ä—É—Ç–∏–Ωa –∑–∞–≤–µ—Ä—à–∞–µ—Ç—Å—è**.

---

## 5. **–û—Ç–ø—Ä–∞–≤–∫–∞ —É—Å–ø–µ—à–Ω–æ–≥–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞**
```go
if responseClosed.CompareAndSwap(false, true) {
    response <- document
    close(response) // –ó–∞–∫—Ä—ã–≤–∞–µ–º –∫–∞–Ω–∞–ª –ø–æ—Å–ª–µ –æ—Ç–ø—Ä–∞–≤–∫–∏ —É—Å–ø–µ—à–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç–∞
}
```
- `CompareAndSwap(false, true)` –¥–µ–ª–∞–µ—Ç **–∞—Ç–æ–º–∞—Ä–Ω—É—é –ø—Ä–æ–≤–µ—Ä–∫—É –∏ –∑–∞–º–µ–Ω—É**:
  - –ï—Å–ª–∏ `responseClosed == false`, –º–µ–Ω—è–µ—Ç –µ–≥–æ –Ω–∞ `true` –∏ –≤—ã–ø–æ–ª–Ω—è–µ—Ç –æ—Ç–ø—Ä–∞–≤–∫—É.
  - –ï—Å–ª–∏ `responseClosed == true`, –∑–Ω–∞—á–∏—Ç, –¥—Ä—É–≥–æ–π —Å–µ—Ä–≤–µ—Ä —É–∂–µ –æ—Ç–ø—Ä–∞–≤–∏–ª –æ—Ç–≤–µ—Ç, –∏ –Ω–∏—á–µ–≥–æ –Ω–µ –¥–µ–ª–∞–µ–º.
- `response <- document` ‚Äî –æ—Ç–ø—Ä–∞–≤–∫–∞ —É—Å–ø–µ—à–Ω–æ–≥–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ –≤ –∫–∞–Ω–∞–ª.
- `close(response)` ‚Äî **–∑–∞–∫—Ä—ã–≤–∞–µ–º –∫–∞–Ω–∞–ª**, —á—Ç–æ–±—ã —Å–∏–≥–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏.

---

## 6. **–û–±—Ä–∞–±–æ—Ç–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ –≤ `select`**
```go
select {
case output := <-response:
    return output, nil
case err := <-errChan:
    return nil, err
}
```
- `select` –∂–¥–µ—Ç **–ª–∏–±–æ —É—Å–ø–µ—à–Ω—ã–π –æ—Ç–≤–µ—Ç, –ª–∏–±–æ –æ—à–∏–±–∫—É**:
  - `case output := <-response:`  
    - –ï—Å–ª–∏ –ø–æ–ª—É—á–µ–Ω —Ä–µ–∑—É–ª—å—Ç–∞—Ç, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º `output, nil`.
  - `case err := <-errChan:`  
    - –ï—Å–ª–∏ –ø–æ–ª—É—á–µ–Ω–∞ –æ—à–∏–±–∫–∞, –∑–Ω–∞—á–∏—Ç, –≤—Å–µ —Å–µ—Ä–≤–µ—Ä–∞ –≤–µ—Ä–Ω—É–ª–∏ –æ—à–∏–±–∫—É, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º `nil, err`.

---

## üîç **–û–±—ä—è—Å–Ω–µ–Ω–∏–µ –∞—Ç–æ–º–∏–∫–æ–≤ (`atomic.Int32` –∏ `atomic.Bool`)**
### 1. **`errCounter.Add(1)`**
- `Add(1)` **–∞—Ç–æ–º–∞—Ä–Ω–æ —É–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç** —Å—á–µ—Ç—á–∏–∫ `errCounter` –Ω–∞ 1.
- –≠—Ç–æ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ, –ø–æ—Ç–æ–º—É —á—Ç–æ –≤ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã—Ö –≥–æ—Ä—É—Ç–∏–Ω–∞—Ö –æ–±—ã—á–Ω–∞—è `int` –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è –º–æ–≥–ª–∞ –±—ã –ø—Ä–∏–≤–µ—Å—Ç–∏ –∫ **–≥–æ–Ω–∫–µ –¥–∞–Ω–Ω—ã—Ö**.

### 2. **`responseClosed.Load()`**
- **–ë–µ–∑–æ–ø–∞—Å–Ω–æ —á–∏—Ç–∞–µ—Ç** —Ç–µ–∫—É—â–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ `responseClosed`.
- –≠—Ç–æ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ, —Ç–∞–∫ –∫–∞–∫ –≥–æ—Ä—É—Ç–∏–Ω—ã —Ä–∞–±–æ—Ç–∞—é—Ç –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ.

### 3. **`responseClosed.CompareAndSwap(false, true)`**
- –≠—Ç–æ **–∞—Ç–æ–º–∞—Ä–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –∏ –∑–∞–º–µ–Ω–∞**.
- –†–∞–±–æ—Ç–∞–µ—Ç –∫–∞–∫:
  ```go
  if responseClosed == false {
      responseClosed = true
      return true
  } else {
      return false
  }
  ```
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è, —á—Ç–æ–±—ã **–≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ —Ç–æ–ª—å–∫–æ –æ–¥–Ω–∞ –≥–æ—Ä—É—Ç–∏–Ω–∞ –º–æ–≥–ª–∞ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —É—Å–ø–µ—à–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç**.

---

## üî• **–ü–ª—é—Å—ã —Ä–µ—à–µ–Ω–∏—è**
‚úÖ **–ù–µ—Ç –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫ (`sync.Mutex` –Ω–µ –Ω—É–∂–µ–Ω)** ‚Äî –≤—Å–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ—Ç–æ–∫–∞–º–∏ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç —á–µ—Ä–µ–∑ –∞—Ç–æ–º–∞—Ä–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏.  
‚úÖ **–ì–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω —É—Å–ø–µ—à–Ω—ã–π –æ—Ç–≤–µ—Ç** ‚Äî –∑–∞ —ç—Ç–æ –æ—Ç–≤–µ—á–∞–µ—Ç `CompareAndSwap()`.  
‚úÖ **–ù–µ –∂–¥–µ–º –æ—à–∏–±–∫–∏, –µ—Å–ª–∏ –µ—Å—Ç—å —É—Å–ø–µ—à–Ω—ã–π –æ—Ç–≤–µ—Ç**.  
‚úÖ **–ï—Å–ª–∏ –≤—Å–µ —Å–µ—Ä–≤–µ—Ä—ã –¥–∞–ª–∏ –æ—à–∏–±–∫—É, –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è `"all servers reply with error"`**.  
‚úÖ **–†–∞–±–æ—Ç–∞–µ—Ç –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ, —Ç–∞–∫ –∫–∞–∫ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–Ω—ã–µ –≥–æ—Ä—É—Ç–∏–Ω—ã**.

---

## ‚ùó **–ß—Ç–æ –º–æ–∂–Ω–æ —É–ª—É—á—à–∏—Ç—å?**
1. **–ó–∞–∫—Ä—ã—Ç–∏–µ `errChan`**  
   - –ú–æ–∂–µ—Ç –±—ã—Ç—å –æ–ø–∞—Å–Ω—ã–º, –µ—Å–ª–∏ –Ω–µ—Å–∫–æ–ª—å–∫–æ –≥–æ—Ä—É—Ç–∏–Ω –ø–æ–ø—ã—Ç–∞—é—Ç—Å—è –∑–∞–∫—Ä—ã—Ç—å `errChan`.
   - –ú–æ–∂–Ω–æ –æ—Å—Ç–∞–≤–∏—Ç—å `errChan` –Ω–µ–∑–∞–∫—Ä—ã—Ç—ã–º ‚Äî `select` –∏ —Ç–∞–∫ –∑–∞–≤–µ—Ä—à–∏—Ç—Å—è –ø–æ—Å–ª–µ –ø–æ–ª—É—á–µ–Ω–∏—è –æ—à–∏–±–∫–∏.

2. **–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—à–∏–±–æ–∫**  
   - –°–µ–π—á–∞—Å –æ—à–∏–±–∫–∏ –ø—Ä–æ—Å—Ç–æ —É—á–∏—Ç—ã–≤–∞—é—Ç—Å—è, –Ω–æ –Ω–µ –ª–æ–≥–∏—Ä—É—é—Ç—Å—è.
   - –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å `log.Println(err)` –ø–µ—Ä–µ–¥ `errCounter.Add(1)`, —á—Ç–æ–±—ã –≤–∏–¥–µ—Ç—å, –∫–∞–∫–∏–µ –æ—à–∏–±–∫–∏ –±—ã–ª–∏.

---

## üèÜ **–§–∏–Ω–∞–ª—å–Ω–∞—è –≤–µ—Ä—Å–∏—è —Å –¥–æ—Ä–∞–±–æ—Ç–∫–∞–º–∏**
```go
func Search(servers []string, query string) ([]string, error) {
    response := make(chan []string, 1)
    errChan := make(chan error, 1)
    var errCounter atomic.Int32
    var responseClosed atomic.Bool

    for _, server := range servers {
        go func(server string) {
            if responseClosed.Load() {
                return
            }

            document, err := search.Search(server, query)
            if err != nil {
                if errCounter.Add(1) == int32(len(servers)) {
                    select {
                    case errChan <- fmt.Errorf("all servers reply with error"):
                    default:
                    }
                }
                return
            }

            if responseClosed.CompareAndSwap(false, true) {
                select {
                case response <- document:
                default:
                }
            }
        }(server)
    }

    select {
    case output := <-response:
        return output, nil
    case err := <-errChan:
        return nil, err
    }
}
```

### üöÄ **–ß—Ç–æ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å?**
‚úÖ **–£–±—Ä–∞–Ω–æ `close(response)`, –ø–æ—Ç–æ–º—É —á—Ç–æ `select` –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–≤–µ—Ä—à–∏—Ç—Å—è**.  
‚úÖ **–£–±—Ä–∞–Ω–æ `close(errChan)`, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å `panic` –≤ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–Ω–æ–º –¥–æ—Å—Ç—É–ø–µ**.  
‚úÖ **–î–æ–±–∞–≤–ª–µ–Ω `select` –ø–µ—Ä–µ–¥ `response <- document`, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏**.  

–¢–µ–ø–µ—Ä—å –∫–æ–¥ **–º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –Ω–∞–¥–µ–∂–Ω—ã–π, –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–Ω—ã–π –∏ –±–µ–∑–æ–ø–∞—Å–Ω—ã–π**! üî•üöÄ