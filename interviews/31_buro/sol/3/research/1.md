—Ä–∞—Å—Å–∫–∞–∂–∏ –º–Ω–µ –ø—Ä–æ –∞—Ç–æ–º–∏–∫–∏ –≤ –≥–æ,  CAS –∏ –ø–æ—á–µ–º—É –æ–Ω–∏ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–µ–µ –∏ –±—ã—Å—Ç—Ä–µ–µ

---

–ö–æ–Ω–µ—á–Ω–æ! –î–∞–≤–∞–π –ø–æ–¥—Ä–æ–±–Ω–æ —Ä–∞–∑–±–µ—Ä—ë–º, **—á—Ç–æ —Ç–∞–∫–æ–µ –∞—Ç–æ–º–∏–∫–∏ –≤ Go**, –∫–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç **CAS (Compare-And-Swap)**, –∏ **–ø–æ—á–µ–º—É —ç—Ç–æ –±—ã—Å—Ç—Ä–µ–µ, —á–µ–º –º—å—é—Ç–µ–∫—Å—ã**.

---

## üîπ –ß—Ç–æ —Ç–∞–∫–æ–µ **–∞—Ç–æ–º–∏–∫–∏ –≤ Go**

–ê—Ç–æ–º–∏–∫–∏ (atomic operations) ‚Äî —ç—Ç–æ **–Ω–∏–∑–∫–æ—É—Ä–æ–≤–Ω–µ–≤—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏**, –∫–æ—Ç–æ—Ä—ã–µ –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è **–Ω–µ–ø—Ä–µ—Ä—ã–≤–Ω–æ (–∞—Ç–æ–º–∞—Ä–Ω–æ)** ‚Äî –±–µ–∑ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –±—ã—Ç—å –ø—Ä–µ—Ä–≤–∞–Ω–Ω—ã–º–∏.

–í Go –æ–Ω–∏ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω—ã –≤ –ø–∞–∫–µ—Ç–µ:

```go
import "sync/atomic"
```

–ü—Ä–∏–º–µ—Ä—ã –∞—Ç–æ–º–∏—á–µ—Å–∫–∏—Ö –æ–ø–µ—Ä–∞—Ü–∏–π:

```go
atomic.AddInt64(&x, 1)             // –±–µ–∑–æ–ø–∞—Å–Ω–æ–µ –∏–Ω–∫—Ä–µ–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
atomic.LoadInt64(&x)               // –±–µ–∑–æ–ø–∞—Å–Ω–æ–µ —á—Ç–µ–Ω–∏–µ
atomic.StoreInt64(&x, 42)          // –±–µ–∑–æ–ø–∞—Å–Ω–∞—è –∑–∞–ø–∏—Å—å
atomic.CompareAndSwapInt64(&x, old, new) // CAS
```

---

## üîπ –ß—Ç–æ —Ç–∞–∫–æ–µ **CAS (Compare-And-Swap)**

CAS ‚Äî —ç—Ç–æ –ø—Ä–∏–º–∏—Ç–∏–≤ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏:

```go
atomic.CompareAndSwapInt64(&x, expected, new)
```

–û–Ω –¥–µ–ª–∞–µ—Ç —Å–ª–µ–¥—É—é—â–µ–µ:

1. –°—Ä–∞–≤–Ω–∏–≤–∞–µ—Ç –∑–Ω–∞—á–µ–Ω–∏–µ `x` —Å `expected`
2. –ï—Å–ª–∏ –æ–Ω–∏ —Ä–∞–≤–Ω—ã ‚Üí –∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç `new` –≤ `x` –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç `true`
3. –ï—Å–ª–∏ –Ω–µ—Ç ‚Üí –Ω–∏—á–µ–≥–æ –Ω–µ –¥–µ–ª–∞–µ—Ç –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç `false`

> CAS ‚Äî **–æ—Å–Ω–æ–≤–∞** –±–æ–ª—å—à–∏–Ω—Å—Ç–≤–∞ lock-free –∞–ª–≥–æ—Ä–∏—Ç–º–æ–≤!

---

## üß† –ü—Ä–∏–º–µ—Ä: –±–µ–∑–æ–ø–∞—Å–Ω—ã–π –∏–Ω–∫—Ä–µ–º–µ–Ω—Ç —Å CAS

```go
func AtomicIncrement(x *int64) {
    for {
        old := atomic.LoadInt64(x)
        if atomic.CompareAndSwapInt64(x, old, old+1) {
            break
        }
        // –µ—Å–ª–∏ –Ω–µ –ø–æ–ª—É—á–∏–ª–æ—Å—å ‚Äî –ø–æ–≤—Ç–æ—Ä—è–µ–º (–∫–æ–Ω–∫—É—Ä–µ–Ω—Ü–∏—è)
    }
}
```

---

## üöÄ –ü–æ—á–µ–º—É –∞—Ç–æ–º–∏–∫–∏ –∏ CAS **–±—ã—Å—Ç—Ä–µ–µ**?

### üî∏ 1. **–ë–µ–∑ –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫**

* `sync.Mutex` —Ç—Ä–µ–±—É–µ—Ç –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ (–≤ —Å–ª—É—á–∞–µ –æ–∂–∏–¥–∞–Ω–∏—è)
* –ê—Ç–æ–º–∏–∫–∏ ‚Äî —ç—Ç–æ **–æ–¥–Ω–∞ –º–∞—à–∏–Ω–Ω–∞—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è** ‚Üí CPU –Ω–µ –±–ª–æ–∫–∏—Ä—É–µ—Ç—Å—è

### üî∏ 2. **–ë–µ–∑ —è–¥—Ä–∞ (kernel-free)**

* `Mutex` –º–æ–∂–µ—Ç –ø—Ä–∏–≤–µ—Å—Ç–∏ –∫ –≤—ã–∑–æ–≤—É –≤ —è–¥—Ä–æ –û–° ‚Üí –¥–æ—Ä–æ–≥–æ
* –ê—Ç–æ–º–∏–∫–∏ —Ä–∞–±–æ—Ç–∞—é—Ç **–Ω–∞ —É—Ä–æ–≤–Ω–µ –ø—Ä–æ—Ü–µ—Å—Å–æ—Ä–∞** (—á–µ—Ä–µ–∑ `LOCK CMPXCHG` –∏ –∞–Ω–∞–ª–æ–≥–∏)

### üî∏ 3. **–ü–∞—Ä–∞–ª–ª–µ–ª–∏–∑–º –±–µ–∑ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏**

* –ü–æ—Ç–æ–∫–∏ –º–æ–≥—É—Ç **–ø—Ä–æ–¥–æ–ª–∂–∞—Ç—å —Ä–∞–±–æ—Ç–∞—Ç—å** –∏ –ø–æ–≤—Ç–æ—Ä—è—Ç—å CAS –≤ —Ü–∏–∫–ª–µ (–µ—Å–ª–∏ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–Ω–æ—Å—Ç—å –≤—ã—Å–æ–∫–∞)
* –≠—Ç–æ –¥–∞—ë—Ç –±–æ–ª–µ–µ –≤—ã—Å–æ–∫—É—é –ø—Ä–æ–ø—É—Å–∫–Ω—É—é —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å (throughput)

---

## ‚ö†Ô∏è –ù–æ –µ—Å—Ç—å **–æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è**:

| –ù–µ–¥–æ—Å—Ç–∞—Ç–æ–∫                   | –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π                                                 |
| ---------------------------- | ----------------------------------------------------------- |
| –¢—Ä—É–¥–Ω–æ —á–∏—Ç–∞—Ç—å                | –ö–æ–¥ —Å CAS —á–∞—Å—Ç–æ —Å–ª–æ–∂–µ–Ω –¥–ª—è –ø–æ–Ω–∏–º–∞–Ω–∏—è                        |
| –ù–µ—Ç –æ–±–æ–±—â—ë–Ω–Ω–æ—Å—Ç–∏             | –¢–æ–ª—å–∫–æ –ø—Ä–∏–º–∏—Ç–∏–≤–Ω—ã–µ —Ç–∏–ø—ã (`int32`, `int64`, `uintptr`)       |
| –ù–µ –º–∞—Å—à—Ç–∞–±–∏—Ä—É–µ—Ç—Å—è            | –ü—Ä–∏ –≤—ã—Å–æ–∫–æ–π –∫–æ–Ω–∫—É—Ä–µ–Ω—Ü–∏–∏ CAS –º–æ–∂–µ—Ç –º–Ω–æ–≥–æ —Ä–∞–∑ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞—Ç—å—Å—è |
| –ù–µ—Ç –ø–æ–¥–¥–µ—Ä–∂–∫–∏ –≥—Ä—É–ø–ø –æ–ø–µ—Ä–∞—Ü–∏–π | –ù–µ–ª—å–∑—è —Å–¥–µ–ª–∞—Ç—å "–∞—Ç–æ–º–∞—Ä–Ω–æ –æ–±–Ω–æ–≤–∏ X –∏ Y –≤–º–µ—Å—Ç–µ"               |

---

## üìä –°—Ä–∞–≤–Ω–µ–Ω–∏–µ: `sync.Mutex` vs `sync/atomic`

| –ö—Ä–∏—Ç–µ—Ä–∏–π           | `sync.Mutex`  | `sync/atomic`                    |
| ------------------ | ------------- | -------------------------------- |
| –ü—Ä–æ—Å—Ç–æ—Ç–∞           | ‚úÖ –ª–µ–≥–∫–æ       | ‚ö†Ô∏è —Å–ª–æ–∂–Ω–æ                        |
| –°–∫–æ—Ä–æ—Å—Ç—å           | ‚ùå –º–µ–¥–ª–µ–Ω–Ω–µ–µ   | ‚úÖ –±—ã—Å—Ç—Ä–µ–µ                        |
| –ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å   | ‚ö†Ô∏è –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∞ | ‚ö†Ô∏è –∑–∞–≤–∏—Å–∏—Ç –æ—Ç —É—Ä–æ–≤–Ω—è –∫–æ–Ω–∫—É—Ä–µ–Ω—Ü–∏–∏ |
| –ü–æ–¥–¥–µ—Ä–∂–∫–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä | ‚úÖ –ª—é–±—ã–µ       | ‚ùå —Ç–æ–ª—å–∫–æ –ø—Ä–∏–º–∏—Ç–∏–≤—ã               |

---

## ‚úÖ –ö–æ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∞—Ç–æ–º–∏–∫–∏?

–ò—Å–ø–æ–ª—å–∑—É–π `sync/atomic`, –µ—Å–ª–∏:

* –£ —Ç–µ–±—è –ø—Ä–æ—Å—Ç–æ–π —Å—á—ë—Ç—á–∏–∫, —Ñ–ª–∞–≥, —Å–æ—Å—Ç–æ—è–Ω–∏–µ
* –ù—É–∂–Ω–∞ **–º–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å**
* –¢—ã **–ø–æ–Ω–∏–º–∞–µ—à—å**, –∫–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–Ω–æ—Å—Ç—å –∏ CAS

–í –æ—Å—Ç–∞–ª—å–Ω—ã—Ö —Å–ª—É—á–∞—è—Ö –ª—É—á—à–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `sync.Mutex` –∏–ª–∏ `sync.RWMutex`.

---

–•–æ—á–µ—à—å –ø—Ä–∏–º–µ—Ä **lock-free –æ—á–µ—Ä–µ–¥–∏ (queue)** –∏–ª–∏ —Å—á—ë—Ç—á–∏–∫–∞ —Å CAS?
