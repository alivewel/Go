–ß—Ç–æ —Ç–∞–∫–æ–µ autovacuum?
–†–∞—Å—Å–∫–∞–∂–∏ –ø–æ–¥—Ä–æ–±–Ω–µ–µ –ø—Ä–æ —Å—Ç—Ä–∞—Ç–µ–≥–∏—é –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—è –∑–∞–ø—Ä–æ—Å–∞ ‚Äî Seq Scan, Index Scan, Bitmap Index Scan, Nested Loop, Hash Join 

–û—Ç–ª–∏—á–Ω—ã–π –∑–∞–ø—Ä–æ—Å! –î–∞–≤–∞–π —Å–Ω–∞—á–∞–ª–∞ —Ä–∞–∑–±–µ—Ä—ë–º—Å—è, —á—Ç–æ —Ç–∞–∫–æ–µ `autovacuum`, –∞ –ø–æ—Ç–æ–º –ø–æ–¥—Ä–æ–±–Ω–æ —Ä–∞–∑–±–µ—Ä—ë–º —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—è –∑–∞–ø—Ä–æ—Å–∞ (query execution strategies) ‚Äî **Seq Scan**, **Index Scan**, **Bitmap Index Scan**, **Nested Loop**, **Hash Join** –∏ –¥—Ä.

---

## üîÑ –ß—Ç–æ —Ç–∞–∫–æ–µ `autovacuum` –≤ PostgreSQL?

### üìå –ö—Ä–∞—Ç–∫–æ:

`autovacuum` ‚Äî —ç—Ç–æ **—Ñ–æ–Ω–æ–≤—ã–π –ø—Ä–æ—Ü–µ—Å—Å** –≤ PostgreSQL, –∫–æ—Ç–æ—Ä—ã–π –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏:

1. –û—á–∏—â–∞–µ—Ç "–º—ë—Ä—Ç–≤—ã–µ" —Å—Ç—Ä–æ–∫–∏ (`VACUUM`)
2. –û–±–Ω–æ–≤–ª—è–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É (`ANALYZE`)

---

### üß† –ó–∞—á–µ–º —ç—Ç–æ –Ω—É–∂–Ω–æ?

PostgreSQL –∏—Å–ø–æ–ª—å–∑—É–µ—Ç **MVCC** (–º—É–ª—å—Ç–∏–≤–µ—Ä—Å–∏–æ–Ω–Ω–æ—Å—Ç—å). –ö–∞–∂–¥–æ–µ `UPDATE` –∏–ª–∏ `DELETE` –Ω–µ —É–¥–∞–ª—è–µ—Ç —Å—Ç—Ä–æ–∫—É —Ñ–∏–∑–∏—á–µ—Å–∫–∏, –∞ –ø–æ–º–µ—á–∞–µ—Ç –µ—ë –∫–∞–∫ "–Ω–µ–≤–∏–¥–∏–º—É—é". –≠—Ç–∏ —Å—Ç—Ä–æ–∫–∏:

* –∑–∞–Ω–∏–º–∞—é—Ç –º–µ—Å—Ç–æ,
* –∑–∞–º–µ–¥–ª—è—é—Ç —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ,
* –∏—Å–∫–∞–∂–∞—é—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É.

`autovacuum`:

* —É–¥–∞–ª—è–µ—Ç —ç—Ç–∏ "—Ç—Ä—É–ø—ã",
* –æ–±–Ω–æ–≤–ª—è–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –∑–∞–ø—Ä–æ—Å–æ–≤,
* –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç **–ø–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω–∏–µ xid (transaction ID wraparound)**.

---

### ‚öôÔ∏è –ß—Ç–æ –¥–µ–ª–∞–µ—Ç `autovacuum`?

| –ö–æ–º–∞–Ω–¥–∞   | –ß—Ç–æ –¥–µ–ª–∞–µ—Ç                                |
| --------- | ----------------------------------------- |
| `VACUUM`  | –£–¥–∞–ª—è–µ—Ç –º—ë—Ä—Ç–≤—ã–µ —Å—Ç—Ä–æ–∫–∏, –æ—Å–≤–æ–±–æ–∂–¥–∞–µ—Ç –º–µ—Å—Ç–æ |
| `ANALYZE` | –û–±–Ω–æ–≤–ª—è–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –¥–ª—è –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–∞     |
| `FREEZE`  | –ó–∞—â–∏—â–∞–µ—Ç –æ—Ç –ø–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω–∏—è transaction ID   |

–¢—ã –º–æ–∂–µ—à—å –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å —á–∞—Å—Ç–æ—Ç—É –∏ –ø–æ—Ä–æ–≥–∏ —á–µ—Ä–µ–∑ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã:

```conf
autovacuum = on
autovacuum_vacuum_threshold = 50
autovacuum_analyze_threshold = 50
```

---

## üîß –°—Ç—Ä–∞—Ç–µ–≥–∏–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤

–ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ PostgreSQL –≤—ã–±–∏—Ä–∞–µ—Ç **–æ–ø—Ç–∏–º–∞–ª—å–Ω—É—é —Å—Ç—Ä–∞—Ç–µ–≥–∏—é**, –æ—Å–Ω–æ–≤—ã–≤–∞—è—Å—å –Ω–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–µ, –∏–Ω–¥–µ–∫—Å–µ, —Å–µ–ª–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏, —Å—Ç–æ–∏–º–æ—Å—Ç–∏. –í–æ—Ç –∫–ª—é—á–µ–≤—ã–µ —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏:

---

### üîç 1. **Seq Scan** (–ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ–µ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ)

* –ß—Ç–µ–Ω–∏–µ **–≤—Å–µ—Ö —Å—Ç—Ä–æ–∫ —Ç–∞–±–ª–∏—Ü—ã**, –ø–æ—Å—Ç—Ä–æ—á–Ω–æ.
* –ë—ã—Å—Ç—Ä–æ –Ω–∞ **–º–∞–ª–µ–Ω—å–∫–∏—Ö —Ç–∞–±–ª–∏—Ü–∞—Ö**, –∏–ª–∏ –µ—Å–ª–∏ **–ø–æ—á—Ç–∏ –≤—Å–µ —Å—Ç—Ä–æ–∫–∏ –ø–æ–¥—Ö–æ–¥—è—Ç**.
* **–ù–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –∏–Ω–¥–µ–∫—Å**.

üìå –ü—Ä–∏–º–µ—Ä:

```sql
SELECT * FROM users;
```

---

### üîç 2. **Index Scan**

* –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è **B-Tree –∏–Ω–¥–µ–∫—Å**.
* –•–æ—Ä–æ—à –ø—Ä–∏ **—Å–µ–ª–µ–∫—Ç–∏–≤–Ω–æ–º —É—Å–ª–æ–≤–∏–∏** (–Ω–∞–ø—Ä–∏–º–µ—Ä, `id = 5`).
* –°–∫–∞–Ω–∏—Ä—É–µ—Ç –∏–Ω–¥–µ–∫—Å ‚Üí —á–∏—Ç–∞–µ—Ç –Ω—É–∂–Ω—ã–µ —Å—Ç—Ä–æ–∫–∏ –∏–∑ —Ç–∞–±–ª–∏—Ü—ã (random access).

üìå –ü—Ä–∏–º–µ—Ä:

```sql
SELECT * FROM users WHERE id = 123;
```

---

### üîç 3. **Bitmap Index Scan**

* –ö–æ–º–±–∏–Ω–∏—Ä—É–µ—Ç **–Ω–µ—Å–∫–æ–ª—å–∫–æ –∏–Ω–¥–µ–∫—Å–æ–≤** –∏–ª–∏ **–≤—ã–±–æ—Ä–∫—É —Å –Ω–∏–∑–∫–æ–π —Å–µ–ª–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å—é**.
* –°—Ç—Ä–æ–∏—Ç bitmap-–º–∞—Å—Å–∏–≤ –ø–æ–¥—Ö–æ–¥—è—â–∏—Ö —Å—Ç—Ä–æ–∫ ‚Üí –ø–æ—Ç–æ–º —á–∏—Ç–∞–µ—Ç –∏—Ö **–æ–ø—Ç–æ–º** (batch).

üìå –ü—Ä–∏–º–µ—Ä:

```sql
SELECT * FROM users WHERE country = 'DE' OR age = 25;
```

–ï—Å–ª–∏ `country` –∏ `age` –∏–Ω–¥–µ–∫—Å–∏—Ä–æ–≤–∞–Ω—ã ‚Äî –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ –º–æ–∂–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –æ–±–∞ –∏–Ω–¥–µ–∫—Å–∞.

---

### üîÅ 4. **Nested Loop Join**

* –î–ª—è –∫–∞–∂–¥–æ–π —Å—Ç—Ä–æ–∫–∏ –∏–∑ –ø–µ—Ä–≤–æ–π —Ç–∞–±–ª–∏—Ü—ã ‚Üí –∏—â–µ—Ç —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –≤–æ –≤—Ç–æ—Ä–æ–π.
* –ë—ã—Å—Ç—Ä–æ, –µ—Å–ª–∏ **–ø–µ—Ä–≤–∞—è —Ç–∞–±–ª–∏—Ü–∞ –º–∞–ª–µ–Ω—å–∫–∞—è**, –≤—Ç–æ—Ä–∞—è ‚Äî –∏–Ω–¥–µ–∫—Å–∏—Ä–æ–≤–∞–Ω–∞.

üìå –ü—Ä–∏–º–µ—Ä:

```sql
SELECT * FROM orders JOIN users ON orders.user_id = users.id;
```

–ï—Å–ª–∏ `users.id` –ø—Ä–æ–∏–Ω–¥–µ–∫—Å–∏—Ä–æ–≤–∞–Ω, –∏ `orders` ‚Äî –º–∞–ª–µ–Ω—å–∫–∞—è, `Nested Loop` –±—É–¥–µ—Ç —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–µ–Ω.

---

### ‚öôÔ∏è 5. **Hash Join**

* –°–æ–∑–¥–∞—ë—Ç **—Ö—ç—à-—Ç–∞–±–ª–∏—Ü—É** –∏–∑ –æ–¥–Ω–æ–π —Ç–∞–±–ª–∏—Ü—ã (–æ–±—ã—á–Ω–æ ‚Äî –º–∞–ª–µ–Ω—å–∫–æ–π),
* –ü–æ—Ç–æ–º –ø–æ –Ω–µ–π –∏—â–µ—Ç —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è –≤–æ –≤—Ç–æ—Ä–æ–π —Ç–∞–±–ª–∏—Ü–µ.

üìå –ü—Ä–∏–º–µ—Ä:

```sql
SELECT * FROM big_table JOIN small_table ON big_table.key = small_table.key;
```

–ï—Å–ª–∏ `small_table` –≤–ª–µ–∑–∞–µ—Ç –≤ –ø–∞–º—è—Ç—å ‚Üí Hash Join –±—É–¥–µ—Ç –æ—á–µ–Ω—å –±—ã—Å—Ç—Ä—ã–º.

---

### üîÅ –°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å—Ç—Ä–∞—Ç–µ–≥–∏–π

| –°—Ç—Ä–∞—Ç–µ–≥–∏—è         | –ö–æ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è                   | –ü–ª—é—Å—ã                       | –ú–∏–Ω—É—Å—ã                                      |
| ----------------- | ------------------------------------ | --------------------------- | ------------------------------------------- |
| Seq Scan          | –ú–∞–ª–µ–Ω—å–∫–∞—è —Ç–∞–±–ª–∏—Ü–∞, –Ω–µ—Ç –∏–Ω–¥–µ–∫—Å–∞       | –ü—Ä–æ—Å—Ç–æ—Ç–∞, —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å      | –ú–µ–¥–ª–µ–Ω–Ω–æ –Ω–∞ –±–æ–ª—å—à–∏—Ö –¥–∞–Ω–Ω—ã—Ö                  |
| Index Scan        | –•–æ—Ä–æ—à–∞—è —Å–µ–ª–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å                | –ë—ã—Å—Ç—Ä–æ, —Ç–æ—á–µ—á–Ω–æ             | Random access ‚Üí –º–µ–¥–ª–µ–Ω–Ω–æ –ø—Ä–∏ –±–æ–ª—å—à–æ–º –æ–±—ä—ë–º–µ |
| Bitmap Index Scan | –ù–µ—Å–∫–æ–ª—å–∫–æ –∏–Ω–¥–µ–∫—Å–æ–≤, —Å—Ä–µ–¥–Ω—è—è —Å–µ–ª–µ–∫—Ü–∏—è | –ö–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —É—Å–ª–æ–≤–∏–π      | –ü–æ—Ç—Ä–µ–±–ª—è–µ—Ç –ø–∞–º—è—Ç—å                           |
| Nested Loop Join  | –ú–∞–ª–∞—è –≤–Ω–µ—à–Ω—è—è —Ç–∞–±–ª–∏—Ü–∞ + –∏–Ω–¥–µ–∫—Å       | –ü—Ä–æ—Å—Ç, —Ä–∞–±–æ—Ç–∞–µ—Ç —Å –∏–Ω–¥–µ–∫—Å–∞–º–∏ | –ü–ª–æ—Ö–æ –ø—Ä–∏ –±–æ–ª—å—à–∏—Ö —Ç–∞–±–ª–∏—Ü–∞—Ö                  |
| Hash Join         | –¢–∞–±–ª–∏—Ü–∞ –≤ –ø–∞–º—è—Ç—å, –Ω–µ—Ç –∏–Ω–¥–µ–∫—Å–∞        | –ë—ã—Å—Ç—Ä–æ, –µ—Å–ª–∏ —Ö—ç—à –ø–æ–¥—Ö–æ–¥–∏—Ç   | –ò—Å–ø–æ–ª—å–∑—É–µ—Ç –ø–∞–º—è—Ç—å, –Ω—É–∂–µ–Ω `work_mem`         |

---

## üß™ –ö–∞–∫ —É–≤–∏–¥–µ—Ç—å —Å—Ç—Ä–∞—Ç–µ–≥–∏—é?

```sql
EXPLAIN ANALYZE
SELECT * FROM orders JOIN users ON orders.user_id = users.id;
```

---

## üí° –í—ã–≤–æ–¥:

| –ß—Ç–æ               | –°—É—Ç—å                                                     |
| ----------------- | -------------------------------------------------------- |
| `autovacuum`      | –§–æ–Ω–æ–≤—ã–π –ø—Ä–æ—Ü–µ—Å—Å, —É–¥–∞–ª—è–µ—Ç –º—É—Å–æ—Ä –∏ –æ–±–Ω–æ–≤–ª—è–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É    |
| –ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫       | –ò—Å–ø–æ–ª—å–∑—É–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É, —á—Ç–æ–±—ã –≤—ã–±—Ä–∞—Ç—å –Ω–∞–∏–ª—É—á—à—É—é —Å—Ç—Ä–∞—Ç–µ–≥–∏—é |
| Index Scan        | –õ—É—á—à–∏–π –¥–ª—è —Ç–æ—á–µ—á–Ω–æ–π –≤—ã–±–æ—Ä–∫–∏                              |
| Bitmap Index Scan | –ü–æ–¥—Ö–æ–¥–∏—Ç –¥–ª—è —Å–ª–æ–∂–Ω—ã—Ö —É—Å–ª–æ–≤–∏–π –∏ `IN`, `OR`                |
| Hash Join         | –õ—É—á—à–∏–π –±–µ–∑ –∏–Ω–¥–µ–∫—Å–æ–≤, –µ—Å–ª–∏ —Ç–∞–±–ª–∏—Ü–∞ –ø–æ–º–µ—â–∞–µ—Ç—Å—è –≤ –ø–∞–º—è—Ç—å    |
| Nested Loop       | –•–æ—Ä–æ—à –¥–ª—è –º–∞–ª–µ–Ω—å–∫–∏—Ö —Ç–∞–±–ª–∏—Ü –∏ —Ç–æ—á–Ω—ã—Ö `JOIN` —Å –∏–Ω–¥–µ–∫—Å–æ–º    |

---

–•–æ—á–µ—à—å ‚Äî –º–æ–≥—É —Å–æ—Å—Ç–∞–≤–∏—Ç—å –≤–∏–∑—É–∞–ª—å–Ω—É—é —Ç–∞–±–ª–∏—Ü—É –≤—Å–µ—Ö —Å—Ç—Ä–∞—Ç–µ–≥–∏–π –∏–ª–∏ –¥–∞—Ç—å –∂–∏–≤–æ–π –ø—Ä–∏–º–µ—Ä —Å `EXPLAIN ANALYZE` –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Å–ª—É—á–∞—è.
