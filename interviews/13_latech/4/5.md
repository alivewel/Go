user
id integer | balance real

func withdrawBalance(user_id int32, amount float32) {
    balance := exec('select balance from user u where u.id=$1', user_id)
    if balance - amount >= 0.0 {
        exec('update user u set balance=balance-$1', amount)
        return exec('select balance from user u where u.id=$1', user_id)
    }
}


1) Может ли здесь быть отрицательный баланс в этой функции?
2) Деньги во флоат.
3) В строке 7 exec('update user u set balance=balance-$1', amount), мы не передаем user_id, меняем баланс у всех пользователей.

1:30:00 Транзакции

1:34:00
### Какие примитивы синхронизации есть в БД аналогично мьютексу?
Мы можем взять select for update и взять блокировку

BEGIN;
SELECT balance FROM user WHERE id=$1 FOR UPDATE;
UPDATE user SET balance=balance-$2 WHERE id=$1;
COMMIT;

1:35:00 

### Какие уровни изоляции бывают и какие проблемы они решают?

Read Uncommitted (Чтение незафиксированных данных): Это самый низкий уровень изоляции, при котором транзакции могут читать данные, которые были изменены, но еще не зафиксированы другими транзакциями. Это может привести к "грязным" чтениям, когда транзакция видит данные, которые могут быть отменены.
Read Committed (Чтение зафиксированных данных): На этом уровне транзакции могут читать только те данные, которые были зафиксированы. Это предотвращает грязные чтения, но может привести к неповторяемым чтениям, когда данные, прочитанные в одной транзакции, могут измениться в другой.
Repeatable Read (Повторяемое чтение): Этот уровень гарантирует, что если транзакция читает данные, она будет видеть те же данные при последующих чтениях в рамках этой же транзакции. Однако, он не защищает от фантомных чтений, когда новые строки могут быть добавлены другой транзакцией.
Serializable (Сериализуемый): Это самый высокий уровень изоляции, который обеспечивает полную изоляцию транзакций. Он гарантирует, что результаты выполнения транзакций будут такими же, как если бы они выполнялись последовательно, одна за другой. Это предотвращает все виды конфликтов, но может значительно снизить производительность из-за блокировок.

